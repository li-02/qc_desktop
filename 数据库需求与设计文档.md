### 数据库需求与设计文档

#### 1. 引言

本文档旨在为应用程序的数据管理模块提供详细的需求分析与数据库设计方案。系统需要管理**站点**、**数据集**及其在处理过程中的不同状态（原始、异常值过滤后、质量控制后等），并记录详细的统计元数据。

#### 2. 需求分析

##### 2.1 核心实体

- **站点 (Site)**: 应用程序的顶层管理单元，代表实际的数据采集地点。需要记录站点的**地理位置信息（经度、纬度、高度）**。

- **数据集 (Dataset)**: 数据分析的基本单元，通常对应一个导入的文件。

- **站点-数据集关联**: 一个站点包含多个数据集。

- **数据集版本 (Dataset Version/Snapshot)**: 数据集在处理流程中的不同快照。关键阶段包括：原始状态 (RAW)、异常值筛选后 (FILTERED)、质量控制后 (QC)。

- **版本追溯机制**: 需保存历史版本以便用户回溯数据处理过程。

##### 2.2 元数据记录需求

对于每一个数据集的版本（快照），必须记录以下统计信息：

- **基础维度**: 总行数 (Total Rows)、总列数 (Total Columns)。

- **总体质量**: 总缺失记录数 (Total Missing Count)。

- **列级质量**: 每一列的缺失记录数、异常值数、列名等（由于列是不确定的，需动态存储）。

- **列阈值配置**: 针对每列，需要配置其异常值过滤的上下限阈值。

##### 2.3 存储方案探讨：数据库 vs 纯文件

- **推荐方案 (Hybrid - 混合模式)**:
  
  - **SQLite (元数据层)**: 存储站点结构、数据集关系、以及所有的统计元数据（行数、列统计JSON、列配置）。SQLite 单文件特性便于携带，且具备强大的查询与事务能力。
  
  - **文件系统 (数据层)**: 实际的庞大表格数据（如 CSV, Parquet）按照Parquet格式存储在文件系统中，数据库仅存储文件路径

#### 3. 数据库设计 (Schema Design)

##### 3.1 ER 图概念模型

```
erDiagram
    sys_site ||--o{ sys_dataset : creates
    sys_dataset ||--o{ conf_column_setting : has
    sys_dataset ||--o{ biz_dataset_version : manages
    biz_dataset_version ||--o{ stat_version_detail : generates_stats

    sys_site {
        INTEGER id PK "站点ID"
        TEXT site_name "站点名称"
        TEXT description "描述"
        REAL latitude "纬度"
        REAL longitude "经度"
        REAL altitude "高度"
        DATETIME created_at "创建时间"
        DATETIME updated_at "更新时间"
    }

    sys_dataset {
        INTEGER id PK "数据集ID"
        INTEGER site_id FK "所属站点ID"
        TEXT dataset_name "数据集名称"
        TEXT source_file_path "原始文件路径"
        DATETIME import_time "导入时间"
        TEXT description "描述"
    }

    conf_column_setting {
        INTEGER id PK "列配置ID"
        INTEGER dataset_id FK "所属数据集ID"
        TEXT column_name "列名"
        INTEGER column_index "列索引"
        TEXT data_type "数据类型"
        REAL min_threshold "最小值阈值"
        REAL max_threshold "最大值阈值"
        BOOLEAN is_active "是否启用"
    }

    biz_dataset_version {
        INTEGER id PK "数据版本ID"
        INTEGER dataset_id FK "所属数据集ID"
        INTEGER parent_version_id FK "父版本ID (自引用)"
        TEXT stage_type "阶段类型 (RAW, FILTERED, QC)"
        BLOB content_blob "数据内容 (Parquet/Pickle)"
        DATETIME created_at "创建时间"
        TEXT remark "备注"
    }

    stat_version_detail {
        INTEGER id PK "统计详情ID"
        INTEGER version_id FK "所属版本ID"
        INTEGER total_rows "总行数"
        INTEGER total_cols "总列数"
        INTEGER total_missing_count "总缺失数"
        INTEGER total_outlier_count "总异常值数"
        TEXT column_stats_json
 "列统计JSON"
        DATETIME calculated_at "计算时间"
    }
```

##### 3.2 表结构定义

###### 3.2.1 站点表 (`sys_site`)

存储站点的基本信息和地理位置。

| 字段名           | 类型       | 约束                        | 说明      |
| ------------- | -------- | ------------------------- | ------- |
| `id`          | INTEGER  | PRIMARY KEY AUTOINCREMENT | 站点ID    |
| `site_name`   | TEXT     | NOT NULL                  | 站点名称    |
| `description` | TEXT     |                           | 描述      |
| `latitude`    | REAL     |                           | 纬度      |
| `longitude`   | REAL     |                           | 经度      |
| `altitude`    | REAL     |                           | 高度 (海拔) |
| `created_at`  | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间    |
| `updated_at`  | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间    |

###### 3.2.2 数据集表 (`sys_dataset`)

存储数据集的全局信息。

| 字段名                | 类型       | 约束                        | 说明                  |
| ------------------ | -------- | ------------------------- | ------------------- |
| `id`               | INTEGER  | PRIMARY KEY AUTOINCREMENT | 数据集ID               |
| `site_id`          | INTEGER  | NOT NULL                  | 外键 -> `sys_site.id` |
| `dataset_name`     | TEXT     | NOT NULL                  | 数据集名称（如文件名）         |
| `source_file_path` | TEXT     |                           | 原始文件来源路径            |
| `import_time`      | DATETIME | DEFAULT CURRENT_TIMESTAMP | 导入时间                |
| `description`      | TEXT     |                           | 描述                  |

###### 3.2.3 列配置表 (`conf_column_setting`)

存储每个数据集包含的列及其质控规则。

| 字段名             | 类型      | 约束                        | 说明                     |
| --------------- | ------- | ------------------------- | ---------------------- |
| `id`            | INTEGER | PRIMARY KEY AUTOINCREMENT | 列配置ID                  |
| `dataset_id`    | INTEGER | NOT NULL                  | 外键 -> `sys_dataset.id` |
| `column_name`   | TEXT    | NOT NULL                  | 列名                     |
| `column_index`  | INTEGER |                           | 列在文件中的顺序               |
| `data_type`     | TEXT    |                           | 数据类型                   |
| `min_threshold` | REAL    |                           | 最小值阈值                  |
| `max_threshold` | REAL    |                           | 最大值阈值                  |
| `is_active`     | BOOLEAN | DEFAULT 1                 | 是否参与计算                 |

###### 3.2.4 数据版本表 (`biz_dataset_version`)

核心表：存储数据集在不同处理阶段的数据快照。

| 字段名                 | 类型           | 约束                        | 说明                       |
| ------------------- | ------------ | ------------------------- | ------------------------ |
| `id`                | INTEGER      | PRIMARY KEY AUTOINCREMENT | 数据版本ID                   |
| `dataset_id`        | INTEGER      | NOT NULL                  | 外键 -> `sys_dataset.id`   |
| `parent_version_id` | INTEGER      |                           | 父版本ID (自引用，用于追溯)         |
| `stage_type`        | TEXT         | NOT NULL                  | 阶段标识 (RAW, FILTERED, QC) |
| `file_path`         | varchar(256) | NOT NULL                  | 指向实际数据文件                 |
| `created_at`        | DATETIME     | DEFAULT CURRENT_TIMESTAMP | 创建时间                     |
| `remark`            | TEXT         |                           | 备注                       |

###### 3.2.5 统计详情表 (`stat_version_detail`)

存储每个数据版本的详细统计指标。

| 字段名                   | 类型       | 约束                        | 说明                             |
| --------------------- | -------- | ------------------------- | ------------------------------ |
| `id`                  | INTEGER  | PRIMARY KEY AUTOINCREMENT | 统计详情ID                         |
| `version_id`          | INTEGER  | NOT NULL                  | 外键 -> `biz_dataset_version.id` |
| `total_rows`          | INTEGER  | DEFAULT 0                 | 总记录数                           |
| `total_cols`          | INTEGER  | DEFAULT 0                 | 总列数                            |
| `total_missing_count` | INTEGER  | DEFAULT 0                 | 总缺失记录数                         |
| `total_outlier_count` | INTEGER  | DEFAULT 0                 | 总异常值数                          |
| `column_stats_json`   | TEXT     |                           | JSON格式的列级统计信息                  |
| `calculated_at`       | DATETIME | DEFAULT CURRENT_TIMESTAMP | 计算时间                           |

##### 3.3 JSON 数据结构示例 (`stat_version_detail` 表中的 `column_stats_json` 字段)

```
{
  "Ta_2m": {
    "missing_count": 10,
    "outlier_count": 5,
    "min_val": -25.5,
    "max_val": 40.2,
    "mean_val": 15.3,
    "std_dev": 8.1
  },
  "SW_IN": {
    "missing_count": 0,
    "outlier_count": 120,
    "min_val": 0,
    "max_val": 1200,
    "mean_val": 350.7,
    "std_dev": 200.5
  },
  "CO2_FLUX": {
    "missing_count": 50,
    "outlier_count": 10,
    "min_val": -30,
    "max_val": 50,
    "mean_val": 5.2,
    "std_dev": 10.1
  }
}
```

#### 4. SQL 操作示例

##### 4.1 插入新的站点

```
INSERT INTO sys_site (site_name, description, latitude, longitude, altitude)
VALUES ('香山观测站', '北京香山森林生态系统观测站', 39.99, 116.19, 400.5);
```

##### 4.2 插入新的数据集及其原始版本和统计

SQL

```
-- 假设 site_id 为 1
INSERT INTO sys_dataset (site_id, dataset_name, source_file_path, description)
VALUES (1, 'sensor_data_202301.csv', '/raw_data/sensor_data_202301.csv', '2023年1月传感器原始数据');

-- 假设 dataset_id 为 1
-- 插入原始数据版本 (content_blob 为 Pandas DataFrame 序列化后的二进制数据)
INSERT INTO biz_dataset_version (dataset_id, stage_type, content_blob, remark)
VALUES (1, 'RAW', X'0123456789abcdef...', '首次导入的原始数据'); 

-- 假设 version_id 为 1
-- 插入该原始版本的统计信息
INSERT INTO stat_version_detail (version_id, total_rows, total_cols, total_missing_count, column_stats_json)
VALUES (1, 1000, 15, 200, 
        json('{"Ta_2m": {"missing_count": 10, "outlier_count": 0}, "SW_IN": {"missing_count": 0, "outlier_count": 0}}')
       );
```

##### 4.3 查询某个站点下所有数据集的最新质控后版本的总行数和总异常值数

SQL

```
SELECT
    s.site_name,
    ds.dataset_name,
    svd.total_rows,
    svd.total_outlier_count
FROM
    sys_site s
JOIN
    sys_dataset ds ON s.id = ds.site_id
JOIN
    biz_dataset_version bdv ON ds.id = bdv.dataset_id
JOIN
    stat_version_detail svd ON bdv.id = svd.version_id
WHERE
    s.site_name = '香山观测站'
    AND bdv.stage_type = 'QC'
    AND bdv.id = ( -- 确保是最新QC版本，这里需要应用层逻辑或MAX(created_at)
        SELECT MAX(id) FROM biz_dataset_version
        WHERE dataset_id = bdv.dataset_id AND stage_type = 'QC'
    );
```

##### 4.4 查询特定数据集（ID=1）某个列（如“Ta_2m”）缺失记录数大于 10 的所有版本

SQL

```
SELECT
    bdv.id AS version_id,
    bdv.stage_type,
    bdv.created_at,
    json_extract(svd.column_stats_json, '$.Ta_2m.missing_count') AS Ta_2m_missing
FROM
    biz_dataset_version bdv
JOIN
    stat_version_detail svd ON bdv.id = svd.version_id
WHERE
    bdv.dataset_id = 1
    AND json_extract(svd.column_stats_json, '$.Ta_2m.missing_count') > 10;
```

#### 5. 总结

本设计采用 **SQLite 内部 BLOB + 文件系统辅助 (可选) 的混合架构**。

- **灵活性**：通过 `conf_column_setting` 和 `stat_version_detail` 表中的 JSON 列完美解决了列不确定的元数据和统计信息存储问题。

- **性能**：实际数据以 BLOB 形式存储在 SQLite 内部，配合应用层（如 Pandas）的高效内存操作，避免频繁文件 IO；元数据和统计信息通过数据库索引实现快速查询。

- **可维护性**：清晰的站点、数据集、版本、统计表结构，支持完整的数据处理链条追溯和历史版本管理。
